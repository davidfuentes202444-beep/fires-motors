<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifas Venezuela</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #btnAdmin {
            position: absolute; right: 20px; top: 20px;
            width: 45px; height: 45px;
            background: #ff6600; border-radius: 50%;
            border: 5px dashed #000; cursor: pointer; z-index: 999;
            animation: spin 5s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .n-btn { width: 45px; height: 45px; font-weight: bold; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .n-selected { background: #22c55e !important; color: white !important; border-color: #16a34a !important; transform: scale(0.9); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-white shadow-md p-6 mb-6 relative">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-black text-blue-900 uppercase">üé∞ Rifas Venezuela</h1>
            <div id="btnAdmin"></div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4">
        
        <div id="adminPanel" class="hidden bg-white p-6 rounded-xl shadow-2xl mb-8 border-4 border-orange-500">
            <h2 class="text-xl font-bold mb-4 uppercase text-orange-600">Nuevo Sorteo</h2>
            <div class="space-y-4">
                <input type="text" id="nombreRifa" class="w-full p-3 border-2 rounded-lg" placeholder="Nombre del Premio">
                <input type="number" id="precioRifa" class="w-full p-3 border-2 rounded-lg" placeholder="Precio por ticket (Bs.)">
                
                <div>
                    <label class="block font-bold text-sm text-gray-600">¬øCu√°ntos n√∫meros se van a rifar?</label>
                    <input type="number" id="cantidadNumeros" class="w-full p-3 border-2 border-orange-300 rounded-lg font-bold" placeholder="Ejemplo: 100">
                </div>

                <div class="bg-blue-50 p-4 rounded-lg border-2 border-dashed border-blue-400">
                    <label class="block font-bold text-blue-700 mb-2">SELECCIONAR FOTO DE LA PC:</label>
                    <input type="file" id="archivoFoto" class="w-full" accept="image/*">
                </div>

                <button id="btnGuardar" class="w-full bg-green-600 text-white font-black py-4 rounded-xl text-lg shadow-lg">PUBLICAR RIFA</button>
            </div>
        </div>

        <div id="formCompra" class="hidden bg-white p-6 rounded-2xl shadow-2xl mb-8 border-t-8 border-green-500">
            <h2 class="text-2xl font-black mb-4 text-green-700 uppercase text-center">Selecciona tus N√∫meros</h2>
            <p id="txtRifaSeleccionada" class="text-center font-bold mb-4 p-3 bg-green-50 rounded border border-green-200"></p>
            
            <div class="mb-6">
                <div id="gridNumeros" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2 bg-gray-50 p-4 rounded-xl max-h-80 overflow-y-auto border shadow-inner"></div>
                <div class="mt-4 p-4 bg-yellow-100 rounded-xl text-center border-2 border-yellow-300">
                    <span class="font-bold text-gray-700">Tus n√∫meros:</span>
                    <p id="listaFinal" class="text-2xl font-black text-orange-600 tracking-widest">---</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="nombreComprador" class="p-3 border-2 rounded-lg" placeholder="Nombre Completo">
                <input type="text" id="cedulaComprador" class="p-3 border-2 rounded-lg" placeholder="C√©dula">
                <button id="btnWhatsApp" class="md:col-span-2 w-full bg-green-600 text-white font-black py-5 rounded-2xl text-xl shadow-xl hover:bg-green-700">ENVIAR PEDIDO POR WHATSAPP</button>
                <button onclick="document.getElementById('formCompra').classList.add('hidden')" class="md:col-span-2 text-gray-400 py-2 font-bold">CANCELAR</button>
            </div>
        </div>

        <div id="contenedorRifas" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCrDZ6_gzi9cV1u2nf-eJ8BKsDesy8SxbE",
            authDomain: "mis-rifas-52a79.firebaseapp.com",
            databaseURL: "https://mis-rifas-52a79-default-rtdb.firebaseio.com",
            projectId: "mis-rifas-52a79",
            storageBucket: "mis-rifas-52a79.appspot.com",
            appId: "1:636792561568:web:feb960e943e7f92777cec5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        const rifasRef = ref(db, 'rifas');

        let seleccionados = [];

        // Genera los n√∫meros seg√∫n el l√≠mite que pusiste en el Admin
        function generarNumeros(limite) {
            const grid = document.getElementById('gridNumeros');
            grid.innerHTML = "";
            for(let i=0; i < limite; i++) {
                let n = i.toString().padStart(2, '0');
                let btn = document.createElement('button');
                btn.className = "n-btn bg-white hover:bg-orange-50";
                btn.innerText = n;
                btn.onclick = () => {
                    if(seleccionados.includes(n)) {
                        seleccionados = seleccionados.filter(item => item !== n);
                        btn.classList.remove('n-selected');
                    } else {
                        seleccionados.push(n);
                        btn.classList.add('n-selected');
                    }
                    document.getElementById('listaFinal').innerText = seleccionados.length > 0 ? seleccionados.join(" - ") : "---";
                };
                grid.appendChild(btn);
            }
        }

        document.getElementById('btnAdmin').onclick = () => {
            if(prompt("Clave:") === "051011") document.getElementById('adminPanel').classList.toggle('hidden');
        };

        document.getElementById('btnGuardar').onclick = async () => {
            const nombre = document.getElementById('nombreRifa').value;
            const precio = document.getElementById('precioRifa').value;
            const cant = document.getElementById('cantidadNumeros').value;
            const foto = document.getElementById('archivoFoto').files[0];
            
            if(nombre && precio && cant && foto) {
                document.getElementById('btnGuardar').innerText = "PUBLICANDO...";
                const sRefImg = sRef(storage, 'fotos/' + Date.now() + "_" + foto.name);
                await uploadBytes(sRefImg, foto);
                const url = await getDownloadURL(sRefImg);
                await push(rifasRef, { nombre, precio, cantidad: cant, imagen: url });
                alert("¬°Rifa creada con " + cant + " n√∫meros!");
                location.reload();
            } else { alert("Rellena todo, incluyendo la cantidad de n√∫meros."); }
        };

        onValue(rifasRef, (snapshot) => {
            const contenedor = document.getElementById('contenedorRifas');
            contenedor.innerHTML = "";
            const data = snapshot.val();
            for (let id in data) {
                const r = data[id];
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-xl p-4 border";
                card.innerHTML = `
                    <img src="${r.imagen}" class="w-full h-64 object-cover rounded-xl mb-4">
                    <h3 class="text-2xl font-black text-center uppercase">${r.nombre}</h3>
                    <p class="text-red-600 font-black text-3xl text-center my-2">Bs. ${r.precio}</p>
                    <p class="text-gray-500 text-center text-sm mb-4">Sorteo de ${r.cantidad} n√∫meros</p>
                    <button class="btn-buy w-full bg-blue-700 text-white font-bold py-4 rounded-xl hover:bg-blue-800">RESERVAR N√öMEROS</button>
                `;
                card.querySelector('.btn-buy').onclick = () => {
                    document.getElementById('formCompra').classList.remove('hidden');
                    document.getElementById('txtRifaSeleccionada').innerText = `${r.nombre} | PRECIO: Bs. ${r.precio}`;
                    window.currentOrder = r;
                    seleccionados = [];
                    document.getElementById('listaFinal').innerText = "---";
                    generarNumeros(r.cantidad); // Usa la cantidad guardada
                    window.scrollTo({top: 0, behavior: 'smooth'});
                };
                contenedor.appendChild(card);
            }
        });

        document.getElementById('btnWhatsApp').onclick = () => {
            const n = document.getElementById('nombreComprador').value;
            const c = document.getElementById('cedulaComprador').value;
            if(n && c && seleccionados.length > 0) {
                const msg = `*NUEVA RESERVA*%0A*Producto:* ${window.currentOrder.nombre}%0A*Cliente:* ${n}%0A*C√©dula:* ${c}%0A*N√∫meros:* ${seleccionados.join(", ")}`;
                window.open(`https://wa.me/584126324690?text=${msg}`, '_blank');
            } else { alert("Por favor elige tus n√∫meros y pon tus datos."); }
        };
    </script>
</body>
</html>
