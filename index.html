<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteos Venezuela - Gesti√≥n Pro</title>
    <style>
        :root { --primary: #d32f2f; --secondary: #1a237e; --success: #25d366; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        #adminSection { display: none; background: white; padding: 20px; border-radius: 15px; border: 2px solid var(--primary); margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        .card-body { padding: 15px; text-align: center; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:100; overflow-y: auto; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 95%; max-width: 450px; position: relative; margin: 20px; }
        
        input, button, select { width: 100%; padding: 12px; margin: 6px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 15px; }
        .btn-buy { background: var(--success); color: white; border: none; font-weight: bold; cursor: pointer; font-size: 18px; margin-top: 15px; }
        
        .pm-info { background: #fff9c4; padding: 12px; border-radius: 8px; border: 1px solid #fbc02d; margin-top: 10px; font-size: 13px; }
        #btnKey { position: fixed; bottom: 10px; right: 10px; opacity: 0.1; background: none; border: none; cursor: pointer; font-size: 20px; }
        label { font-size: 13px; font-weight: bold; color: var(--secondary); margin-left: 5px; }
        .error-num { color: #d32f2f; font-size: 12px; font-weight: bold; display: none; margin-top: -5px; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="adminSection">
    <h3 style="margin:0 0 10px 0; color:var(--primary);">üõ°Ô∏è Panel de Control</h3>
    
    <div id="formNueva">
        <p><b>Crear / Modificar Rifa:</b></p>
        <input type="text" id="t" placeholder="T√≠tulo de la Rifa">
        <input type="number" id="p" placeholder="Precio Bs.">
        <input type="number" id="l" placeholder="L√≠mite de n√∫meros">
        <input type="file" id="i" accept="image/*">
        <button onclick="addOrUpdateRifa()" id="btnSave" style="background:var(--primary); color:white; border:none; cursor:pointer;">Guardar Rifa</button>
        <button onclick="resetAdminForm()" style="background:#ccc; color:black; border:none;">Cancelar Edici√≥n</button>
    </div>
    
    <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee;">
        <p><b>Gesti√≥n de Existentes:</b></p>
        <select id="selAdmin" onchange="cargarDatosEnForm()"></select>
        <input type="text" id="numsVendidos" placeholder="N√∫meros vendidos (ej: 5, 12, 40)">
        <button onclick="marcarVendidos()" style="background:var(--secondary); color:white; border:none; cursor:pointer;">Actualizar N√∫meros Vendidos</button>
        <button onclick="eliminarRifa()" style="background:black; color:white; border:none;">Eliminar Rifa Permanentemente</button>
    </div>
</div>

<h1 style="text-align:center; color:var(--secondary);">üé∞ RIFAS VENEZUELA</h1>
<div class="grid" id="galeria"></div>

<button id="btnKey" onclick="accesoAdmin()">üîë</button>

<div id="m" class="modal">
    <div class="modal-content">
        <span onclick="closeM()" style="float:right; cursor:pointer; font-size:25px; font-weight:bold;">&times;</span>
        <div id="m-body"></div>
    </div>
</div>

<script>
const PASS = "1234";
let rifas = JSON.parse(localStorage.getItem('sorteos_v6')) || [];
let editIndex = -1;

function render() {
    const g = document.getElementById('galeria');
    const s = document.getElementById('selAdmin');
    g.innerHTML = ""; 
    s.innerHTML = "<option value='-1'>Seleccione para modificar o vender...</option>";
    
    rifas.forEach((r, i) => {
        g.innerHTML += `
            <div class="card" onclick="openM(${i})">
                <img src="${r.img}">
                <div class="card-body">
                    <h3 style="margin:5px 0;">${r.t}</h3>
                    <p style="color:var(--primary); font-weight:bold; font-size:20px;">Bs. ${r.p}</p>
                </div>
            </div>`;
        s.innerHTML += `<option value="${i}">${r.t}</option>`;
    });
}

function openM(i) {
    const r = rifas[i];
    document.getElementById('m-body').innerHTML = `
        <h2 style="margin:0 0 10px 0; color:var(--secondary); text-align:center;">${r.t}</h2>
        <label>Nombre Completo</label>
        <input type="text" id="c_nom" placeholder="Ej: Juan P√©rez">
        <label>C√©dula</label>
        <input type="text" id="c_ced" placeholder="Ej: 12345678">
        <label>Tel√©fono</label>
        <input type="tel" id="c_tel" placeholder="Ej: 04121234567">
        <label>N√∫mero Respaldo</label>
        <input type="tel" id="c_res" placeholder="Otro contacto">
        <label>Direcci√≥n Corta</label>
        <input type="text" id="c_dir" placeholder="Ej: La Victoria, Calle 3">
        <label>N√∫meros (separe con coma)</label>
        <input type="text" id="c_nums" placeholder="Escriba los n√∫meros aqu√≠" oninput="validarYRecalc(${i})">
        <div id="error-msg" class="error-num">‚ö†Ô∏è Uno o m√°s n√∫meros ya est√°n apartados.</div>
        <div id="tot" style="font-size:22px; font-weight:bold; color:var(--primary); text-align:center; margin:10px 0;">Total: Bs. 0,00</div>
        <div class="pm-info"><b>PAGO M√ìVIL:</b> BANESCO | 04126324690 | V-33854892</div>
        <button class="btn-buy" id="btnFinal" onclick="comprar(${i})">Enviar a WhatsApp üí¨</button>
    `;
    document.getElementById('m').style.display = 'flex';
}

function validarYRecalc(i) {
    const r = rifas[i];
    const val = document.getElementById('c_nums').value;
    const nums = val.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
    const errorMsg = document.getElementById('error-msg');
    const btn = document.getElementById('btnFinal');
    
    const ocupados = nums.filter(n => r.vendidos.includes(n));
    
    if(ocupados.length > 0) {
        errorMsg.style.display = 'block';
        btn.disabled = true;
        btn.style.opacity = '0.5';
    } else {
        errorMsg.style.display = 'none';
        btn.disabled = false;
        btn.style.opacity = '1';
    }
    
    const total = (nums.length * r.p).toLocaleString('es-VE', { minimumFractionDigits: 2 });
    document.getElementById('tot').innerText = `Total: Bs. ${total}`;
}

function comprar(i) {
    const datos = {
        nom: document.getElementById('c_nom').value,
        ced: document.getElementById('c_ced').value,
        tel: document.getElementById('c_tel').value,
        res: document.getElementById('c_res').value,
        dir: document.getElementById('c_dir').value,
        nums: document.getElementById('c_nums').value
    };

    if(Object.values(datos).some(v => !v)) return alert("Rellena todo el formulario");

    const msg = `üìå *NUEVA COMPRA*%0Aüë§ *Cliente:* ${datos.nom}%0AüÜî *CI:* ${datos.ced}%0Aüìû *Tlf:* ${datos.tel}%0A‚òéÔ∏è *Resp:* ${datos.res}%0Aüè† *Dir:* ${datos.dir}%0AüéüÔ∏è *Rifa:* ${rifas[i].t}%0Aüî¢ *N√∫meros:* ${datos.nums}%0Aüí∞ *Total:* ${document.getElementById('tot').innerText}`;
    window.open(`https://wa.me/584126324690?text=${msg}`);
}

// --- ADMIN ---
function accesoAdmin() { if(prompt("Clave:") === PASS) document.getElementById('adminSection').style.display = 'block'; }

function addOrUpdateRifa() {
    const t=document.getElementById('t').value, p=document.getElementById('p').value, l=document.getElementById('l').value, imgInput=document.getElementById('i');
    if(!t || !p || !l) return alert("Faltan datos");

    const guardar = (imagenData) => {
        const datos = { t, p: parseFloat(p), l: parseInt(l), img: imagenData, vendidos: (editIndex > -1 ? rifas[editIndex].vendidos : []) };
        if(editIndex > -1) rifas[editIndex] = datos;
        else rifas.push(datos);
        save(); render(); resetAdminForm();
        alert("Guardado correctamente");
    };

    if(imgInput.files[0]) {
        const fr = new FileReader();
        fr.onload = (e) => guardar(e.target.result);
        fr.readAsDataURL(imgInput.files[0]);
    } else if (editIndex > -1) {
        guardar(rifas[editIndex].img);
    } else {
        alert("Debes subir una imagen");
    }
}

function cargarDatosEnForm() {
    const idx = document.getElementById('selAdmin').value;
    if(idx == -1) return resetAdminForm();
    editIndex = idx;
    const r = rifas[idx];
    document.getElementById('t').value = r.t;
    document.getElementById('p').value = r.p;
    document.getElementById('l').value = r.l;
    document.getElementById('numsVendidos').value = r.vendidos.join(", ");
    document.getElementById('btnSave').innerText = "Actualizar Rifa Seleccionada";
}

function marcarVendidos() {
    if(editIndex == -1) return alert("Selecciona una rifa primero");
    const val = document.getElementById('numsVendidos').value;
    rifas[editIndex].vendidos = val.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
    save(); alert("Ventas actualizadas");
}

function eliminarRifa() {
    if(editIndex > -1 && confirm("¬øEliminar rifa definitivamente?")) {
        rifas.splice(editIndex, 1);
        save(); render(); resetAdminForm();
    }
}

function resetAdminForm() {
    editIndex = -1;
    document.getElementById('t').value = "";
    document.getElementById('p').value = "";
    document.getElementById('l').value = "";
    document.getElementById('i').value = "";
    document.getElementById('numsVendidos').value = "";
    document.getElementById('btnSave').innerText = "Guardar Rifa";
}

function save() { localStorage.setItem('sorteos_v6', JSON.stringify(rifas)); }
function closeM() { document.getElementById('m').style.display = 'none'; }
render();
</script>
</body>
</html>
